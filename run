#!/usr/bin/env bash
set -euo pipefail

cmd="${1:-help}"
shift 2>/dev/null || true

case "$cmd" in
  build)
    go build ./...
    ;;
  test)
    go test ./... -v -count=1
    ;;
  vet)
    go vet ./...
    ;;
  lint)
    go vet ./...
    echo "lint passed"
    ;;
  clean)
    go clean ./...
    ;;
  demo)
    go run ./cmd/demo
    ;;
  bench)
    go test ./... -bench=. -benchmem -count=3
    ;;
  shake)
    go run ./cmd/shake "$@"
    ;;
  all)
    go build ./...
    go vet ./...
    go test ./... -v -count=1
    ;;
  help|*)
    echo "usage: ./shake.sh <command> [args]"
    echo ""
    echo "commands:"
    echo "  build    go build ./..."
    echo "  test     go test ./... -v"
    echo "  vet      go vet ./..."
    echo "  lint     vet + lint passed"
    echo "  clean    go clean ./..."
    echo "  demo     run demo cmd"
    echo "  bench    benchmarks with -benchmem"
    echo "  shake    run shaker CLI (flags passed through to cmd/shake)"
    echo "  all      build + vet + test"
    echo ""
    echo "shake usage:"
    echo "  ./run shake -paths '\$.foo,\$.bar' [-file input.json] [-output out.json] [-mode exclude]"
    echo "  ./run shake -paths '\$.foo,\$.bar' < input.json"
    ;;
esac
